/*
 * Copyright (c) 2023, Connect Tech Inc.  All rights reserved.
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms and conditions of the GNU General Public License,
 * version 2, as published by the Free Software Foundation.
 *
 * This program is distributed in the hope it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "tegra234-orin-nx-cti-base.dtsi"

/{
    nvidia,dtsfilename = "tegra234-orin-nx-cti-NGX015.dts";

    clocks-init {
        status = "okay";
    };
     
    tachometer@39c0000 {
        status = "disabled";
    };
    pwm-fan {
        status = "disabled";
    };
    can_clock: can_clock{
        compatible = "fixed-clock";
        #clock-cells = <0>;
        clock-frequency = <20000000>;
        clock-accuracy = <100>;
    };

    i2c@c250000 {
        status="okay";
        clock-frequency = <100000>;
        tca9539_74: tca9539@74 {
            compatible = "ti,tca9539";
            gpio-controller;
            #gpio-cells = <2>;
            reg = <0x74>;
            vcc-supply = <&vdd_1v8_sys>;
            status = "okay";
         };
        /** define wakeup for gpio10*/
        wakeup: gpio16@20{
                    compatible="nxp,pca9575";
                    status="okay";
                    reg = <0x20>;

                    gpio-controller;
                    #gpio-cells=<2>;
                    #address-cells = <1>;
                    #size-cells=<0>;
                    vcc-supply = <&vdd_3v3_AO>;

        };
    };

    fixed-regulators{
        /delete-node/ cti_usb_vbus;
        cti_polaris_vbus1: regulator@201 {
            compatible = "regulator-fixed";
            reg=<201>;
            regulator-name = "cti-polaris-otg-vbus";
            regulator-min-microvolt = <5000000>;
            regulator-max-microvolt = <5000000>;
            gpio = <&tegra_main_gpio TEGRA234_MAIN_GPIO(AC, 6) 0>;
            enable-active-high;
            regulator-always-on;
        };
        //absense of enable-active-high makes the regulator active-low
        cti_polaris_coaxA:regulator@220 {
            compatible = "regulator-fixed";
            reg=<220>;
            regulator-name = "cti-polaris-coaxA";
            regulator-min-microvolt = <12000000>;
            regulator-max-microvolt = <12000000>;
            gpio = <&tca9539_74 5 GPIO_ACTIVE_LOW>;
        };
        cti_polaris_coaxB:regulator@221 {
            compatible = "regulator-fixed";
            reg=<221>;
            regulator-name = "cti-polaris-coaxB";
            regulator-min-microvolt = <12000000>;
            regulator-max-microvolt = <12000000>;
            gpio = <&tca9539_74 6 GPIO_ACTIVE_LOW>;
        };
        cti_polaris_coaxC:regulator@222 {
            compatible = "regulator-fixed";
            reg=<222>;
            regulator-name = "cti-polaris-coaxC";
            regulator-min-microvolt = <12000000>;
            regulator-max-microvolt = <12000000>;
            gpio = <&tca9539_74 7 GPIO_ACTIVE_LOW>;
        };
        cti_polaris_coaxD:regulator@223 {
            compatible = "regulator-fixed";
            reg=<223>;
            regulator-name = "cti-polaris-coaxD";
            regulator-min-microvolt = <12000000>;
            regulator-max-microvolt = <12000000>;
            gpio = <&tca9539_74 8 GPIO_ACTIVE_LOW>;
        };
    };

    /** configure gpio10 as wakeup*/
    gpio-keys {
        compatible = "gpio-keys";
        gpio-keys,name = "gpio-keys";
        status = "okay";
        forcerecovery {
            label = "force-recovery";
            gpios = <&tegra_main_gpio TEGRA234_MAIN_GPIO(G, 0) GPIO_ACTIVE_LOW>;
            linux,code = <BTN_1>;
        };

        power_key {
            label = "power-key";
            gpios = <&tegra_aon_gpio TEGRA234_AON_GPIO(EE, 4) GPIO_ACTIVE_LOW>;
            linux,code = <KEY_POWER>;
            gpio-key,wakeup;
        };

        wakeup {
            label = "wakeup";
            gpios = <&tegra_aon_gpio TEGRA234_AON_GPIO(EE, 2) GPIO_ACTIVE_LOW>;
            linux,code = <KEY_POWER>;
            gpio-key,wakeup;
        };
    };


    //enable serial connections



    spi@3230000{ /* SPI3 in 40 pin conn */
        status = "disabled";
    };

    mttcan@c310000{
        status = "okay";
    };
    
    //mcp2517
    spi@3210000{ /* SPI1 in 40 pin conn */
        status = "okay";
        /delete-node/ spi@0;
        can@0 {
            status = "okay";
            compatible = "microchip,mcp2517fd";
            reg = <0>;
            clocks = <&can_clock>;
            vdd-supply = <&hdr40_vdd_3v3>;
            xceiver-supply = <&hdr40_vdd_3v3>;
            spi-max-frequency=<10000000>;

            interrupt-parent = <&tegra_main_gpio>;
           interrupts = <TEGRA234_MAIN_GPIO(Q, 2) IRQ_TYPE_LEVEL_LOW>;

        };

    };
/** GPIO06*/
    //Important! serial console and USB and other peripherals won't work without this!
    gpio@c2f0000 {
        gpio06 {
            gpio-hog;
            status="okay";
            output-high;
            gpios=<TEGRA234_AON_GPIO(CC, 3) GPIO_ACTIVE_HIGH>;
            label="gpio06";
        };

    };

    gpio@2200000 {
        mcp2517-rx-int {
            status="okay";
            gpio-hog;
            input;
            gpios=<TEGRA234_MAIN_GPIO(Q, 2) 0>;
            label="mcp2517-rx-int";
        };
    };

    


    /**define KSZ9897 switch i2c-1*/
    i2c@c240000 {
        status = "okay";
        ksz9897@5f{
            compatible = "microchip,ksz9897";
            reg=<0x5f>;
            status="okay";
            ports{
                #address-cells = <1>;
                #size-cells = <0>;

                port@0{
                    reg = <0>;
                    label = "CON_GBE";
                };

                port@1{
                    reg = <1>;
                    label = "MODULE_INT";
                    fixed-link{
                        speed=<1000>;
                        full-duplex;
                    };
                };

                port@2{
                    reg = <2>;
                    label = "M12_GBE2";
                };


                port@3{
                    reg = <3>;
                    label = "M12_GBE3";
                };

            };
        };
    };


    i2c@3160000{
        //Fan controller
        fan-controller@0x2C{
            compatible="adi,adt7470";
            status="okay";
            reg=<0x2c>;
        };

        //pressure sensor
        pressure-sensor@0x5D{
            compatible="st,lps22hb-press";
            reg=<0x5d>;
            status="okay";
            vdd-supply=<&hdr40_vdd_3v3>;
            vddio-supply=<&hdr40_vdd_3v3>;
        };
    };

    xusb_padctl: xusb_padctl@3520000 {
        status = "okay";
        pads {
            usb2 {
                lanes {
                    usb2-0 {
                        nvidia,function = "xusb";
                        vbus-supply = <&cti_polaris_vbus1>;
                        status = "okay";
                    };
                    usb2-1 {
                        nvidia,function = "xusb";
                        status = "okay";
                    };
                    usb2-2 {
                        nvidia,function = "xusb";
                        status = "okay";
                    };
                };
            };
            usb3 {
                lanes {
                    usb3-0 {
                        nvidia,function = "xusb";
                        status = "okay";
                    };
                    usb3-2 {
                        nvidia,function = "xusb";
                        status = "okay";                        
                    };
                };
            };
        };

        ports {
            usb2-0 {
                mode = "otg";
                status = "okay";
                vbus-supply = <&cti_polaris_vbus1>;
                usb-role-switch;
                /delete-node/ connector;
                connector {
                    /* NOTE: PN: While the Physical connector is Type-C we are using the
                     * microUSB driver as the HW uses the older OTG_ID/VBUS_DET gpio
                     * for indicating role switchs
                     */
                    compatible = "gpio-usb-b-connector", "usb-b-connector";
                    label = "micro-USB";
                    type = "micro";
                    vbus-gpios = <&tegra_main_gpio TEGRA234_MAIN_GPIO(Z, 1) GPIO_ACTIVE_HIGH>;
                    id-gpios = <&tegra_main_gpio TEGRA234_MAIN_GPIO(Q, 6) GPIO_ACTIVE_HIGH>;
                };

            };
            usb2-1 {
                mode = "host";
                status = "okay";
            };
            usb2-2 {/* Goes to M2.E */
                mode = "host";
                status = "okay";
            };
            usb3-0 {
                nvidia,usb2-companion = <2>;
                status = "okay";
            };
            usb3-2{
                nvidia,usb2-companion = <1>;
                status = "okay";                
            };
        };
    };
    tegra_xudc: xudc@3550000 {
        status = "okay";
        phys =  <&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-0}>;
        phy-names = "usb2-0";
        nvidia,xusb-padctl = <&xusb_padctl>;
    };


};

